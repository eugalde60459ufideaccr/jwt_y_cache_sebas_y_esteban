@model Proyecto_CreandoRecuerdos.Models.InsumosModel

@{
    ViewData["Title"] = "Gestión de Costos de Productos Preparados";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="@Url.Content("~/Templates/css/insumos.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/botones.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/tablas.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/paginaciones_y_exportaciones.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/validaciones.css")" rel="stylesheet" />
}

<div class="container my-5 text-center">
    <h2 class="mb-4" style="font-family: 'Sono';">
        <i class="fas fa-calculator me-2"></i>Gestión de Costos de Productos Preparados
    </h2>
</div>

<!-- Formulario de búsqueda -->
<form method="get" action="@Url.Action("productos_preparados", "Insumos")" class="mt-4">
    <div class="input-group mb-4">
        <input type="text" name="search" class="form-control" placeholder="Buscar por cualquier campo..." value="@ViewBag.Search" />
        <button type="submit" class="fas fa-search ms-1 btn btn-custom-pink" title="Buscar"></button>
    </div>
</form>

<!-- Formulario de registro/edición -->
<div id="formProductoPreparadoContainer">
    @Html.Partial("_FormularioProductoPreparado", Model)
</div>

@section ListadoInsumos {
    <!-- Listado -->
    <div class="tabla_insumos_container">
        <h4><strong>Listado de Productos Preparados</strong></h4>
        @if (Model.ProductosPreparados == null || Model.ProductosPreparados.Count == 0)
        {
            <div class="alert alert-info text-center" style="margin: 1rem 0;">
                @if (!string.IsNullOrEmpty(ViewBag.Search as string))
                {
                    <span>No se encontraron coincidencias.</span>
                }
                else
                {
                    <span>No hay productos preparados registrados.</span>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table id="tabla_insumos" class="table mb-0 table-bordered table-striped tabla-global text-center dataTable con-exportaciones" data-page-length="3">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipo</th>
                            <th>Nombre</th>
                            <th>Marca</th>
                            <th>Presentación</th>
                            <th>Cantidad</th>
                            <th>Volumen de Porción de Presentación</th>
                            <th>Unidad de medida de Presentación</th>
                            <th>Volumen de Porción Convertido</th>
                            <th>Unidad de medida del Volumen de Porción Convertido</th>
                            <th>Proveedor</th>
                            <th>Costo (₡)</th>
                            <th>Peso</th>
                            <th>Unidad de medida del Peso</th>
                            <th>Costo por Peso (₡)</th>
                            <th>Costo por Porción con Merma (₡)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="tabla-global">
                        @foreach (var producto_preparado in Model.ProductosPreparados)
                        {
                            <tr>
                                <td>@producto_preparado.id</td>
                                <td>@producto_preparado.tipo</td>
                                <td>@producto_preparado.nombre</td>
                                <td>@producto_preparado.marca</td>
                                <td>@producto_preparado.presentacion</td>
                                <td>@producto_preparado.cantidad</td>
                                <td>
                                    @(producto_preparado.volumen_de_porcion_de_presentacion.HasValue
                                ? producto_preparado.volumen_de_porcion_de_presentacion.Value.ToString("N2"): "")
                                </td>
                                <td>@producto_preparado.unidad_de_medida_de_presentacion</td>
                                <td>@(producto_preparado.volumen_de_porcion_convertido.HasValue ? producto_preparado.volumen_de_porcion_convertido.Value.ToString("N2") : "")</td>
                                <td>@producto_preparado.unidad_de_medida_convertida</td>
                                <td>@producto_preparado.proveedor</td>
                                <td>₡@(producto_preparado.costo.ToString("N2"))</td>
                                <td>@(producto_preparado.cantidad * producto_preparado.volumen_de_porcion_convertido)</td>
                                <td>@producto_preparado.unidad_de_medida_del_peso</td>
                                <td>@(producto_preparado.costo_por_peso.HasValue ? "₡" + producto_preparado.costo_por_peso.Value.ToString("N2"): "")</td>
                                <td>@(producto_preparado.costo_por_porcion_con_merma.HasValue ? "₡" + producto_preparado.costo_por_porcion_con_merma.Value.ToString("N2"): "")</td>
                                <td>
                                    <a href="@Url.Action("EditarProductoPreparado", "Insumos", new { id = producto_preparado.id })" class="btn btn-custom-pink btn-sm fas fa-pencil" title="Editar"></a>
                                    <a href="@Url.Action("EliminarProductoPreparado", "Insumos", new { id = producto_preparado.id })" class="btn btn-danger btn-sm btn-eliminar fas fa-trash" title="Eliminar" data-url="@Url.Action("EliminarProductoPreparado", "Insumos", new { id = producto_preparado.id })"></a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@section Scripts {
    <script src="@Url.Content("~/Templates/js/validaciones.js")"></script>
    <script src="@Url.Content("~/Templates/js/insumos.js")"></script>
    <!-- SweetAlert de éxito tras eliminación -->
    <script>
$(document).ready(function () {
    var msg = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(TempData["SuccessMessage"]));
    if (msg) {
        Swal.fire({
            icon: 'success',
            iconColor: '#82E0AA',
            text: msg,
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#B54885'
        });
    }
});
    </script>
    <script>
        $(document).ready(function () {
            $(document).on('submit', '#formProductoPreparado', function (e) {
                e.preventDefault();
                var $form = $(this);
                if (!$form.valid()) {
                    return false;
                }
                $.ajax({
                    url: $form.attr('action'),
                    type: $form.attr('method'),
                    data: $form.serialize(),
                    dataType: 'html',
                    success: function (response) {
                        var isJson = false;
                        var json;
                        if (typeof response === "object") {
                            json = response;
                            isJson = true;
                        } else if (typeof response === "string" && response.trim().startsWith("{") && response.trim().endsWith("}")) {
                            try {
                                json = JSON.parse(response);
                                isJson = true;
                            } catch (e) { }
                        }
                        // SweetAlert de éxito tras la Creación/Edición
                        if (isJson && json.success) {
                            Swal.fire({
                                icon: 'success',
                                iconColor: '#82E0AA',
                                text: json.message,
                                confirmButtonText: 'Aceptar',
                                confirmButtonColor: '#B54885'
                            }).then(function () {
                                location.reload();
                            });
                            return;
                        }
                        var $newForm = $(response).find('#formProductoPreparado');
                        if ($newForm.length) {
                            $('#formProductoPreparadoContainer').html($newForm);
                            $newForm.validate({
                                errorElement: 'span',
                                errorClass: 'invalid-feedback',
                                highlight: function (element) { $(element).addClass('is-invalid'); },
                                unhighlight: function (element) { $(element).removeClass('is-invalid'); },
                                errorPlacement: function (error, element) { error.insertAfter(element); }
                            });
                        }
                    },
                    error: function () {
                        alert('Error al actualizar el producto preparado.');
                    }
                });
            });
        });
    </script>
    <script src="~/Templates/js/selects.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js" defer></script>
        <script src="@Url.Content("~/Templates/js/paginaciones_y_exportaciones.js")" defer></script>
}