@model Proyecto_CreandoRecuerdos.Models.InsumosModel

@{
    ViewData["Title"] = "Gestión de Precios Finales Sugeridos de Productos Finales";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="@Url.Content("~/Templates/css/insumos.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/botones.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/tablas.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/paginaciones_y_exportaciones.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/selects.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/validaciones.css")" rel="stylesheet" />
    <style>

        /* Estilos para el checkbox de suministros utilizados */

        /* Ocultar checkbox nativo */
        .custom-checkbox input[type="checkbox"] {
            display: none;
        }

        /* Contenedor visual */
        .custom-checkbox span {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-top: 10px
        }

            /* Caja personalizada */
            .custom-checkbox span::before {
                content: "";
                position: absolute;
                width: 100%;
                height: 100%;
                left: 3px;
                border: 1px solid #CED4DA;
                border-radius: 4px;
                box-sizing: border-box;
                background-color: #FFFFFF;
            }

        /* Ocultar el ícono de Font Awesome por defecto */
        .custom-checkbox i.fa-solid.fa-check {
            position: relative;
            z-index: 1; /* Para que el ícono se muestre encima del recuadro */
            color: #FFFFFF;
            font-size: 14px; /* Ajusta el tamaño del ícono si es necesario */
            opacity: 0; /* Ocultamos el ícono */
            transition: opacity 0.2s ease;
        }

        /* Mostrar el ícono y cambiar el fondo cuando el checkbox está activo */
        .custom-checkbox input[type="checkbox"]:checked + span i.fa-solid.fa-check {
            opacity: 1; /* Hacemos visible el ícono */
            position: relative;
            top: 0px;
            left: 3px;
            font-size: 18px;
            color: #FFFFFF;
        }

        /* Cambio de color al estar marcado */
        .custom-checkbox input[type="checkbox"]:checked + span::before {
            border-color: #B54885;
            background-color: #B54885;
        }

        /* Hover */
        .custom-checkbox span:hover::before {
            border-color: #B54885;
            box-shadow: 0 0 0 0.2rem rgba(226, 122, 176, 0.25);
        }
    </style>
}

<div class="container my-5 text-center">
    <h2 class="mb-4" style="font-family: 'Sono';">
        <i class="fas fa-calculator me-2"></i> Gestión de Precios Finales Sugeridos de Productos Finales
    </h2>
</div>

<!-- Formulario de búsqueda -->
<form method="get" action="@Url.Action("precio_final_sugerido", "Insumos")" class="mt-4">
    <h4><strong>Búsqueda de Productos Finales</strong></h4>
    <div class="input-group mb-4">
        <input type="text" name="search" class="form-control" placeholder="Buscar por cualquier campo..." value="@ViewBag.Search" />
        <button type="submit" class="fas fa-search ms-1 btn btn-custom-pink" title="Buscar"></button>
    </div>
</form>

<!-- Formulario de registro/edición -->
<div id="formPreciosFinalesSugeridosContainer">
    @Html.Partial("_FormularioPrecioFinalSugerido", Model)
</div>

@section ListadoInsumos {
    <!-- Listado -->
    <div class="tabla_insumos_container">
        <h4><strong>Listado de Productos Finales</strong></h4>
        @if (Model.ProductosFinales == null || Model.ProductosFinales.Count == 0)
        {
            <div class="alert alert-info text-center" style="margin: 1rem 0;">
                @if (!string.IsNullOrEmpty(ViewBag.Search as string))
                {
                    <span>No se encontraron coincidencias.</span>
                }
                else
                {
                    <span>No hay productos finales registradas.</span>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table id="tabla_insumos" class="table mb-0 table-bordered table-striped tabla-global text-center dataTable con-exportaciones" data-page-length="3">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre de Receta</th>
                            <th>Costo Total de Receta (₡)</th>
                            <th>Margen de Utilidad (%)</th>
                            <th>Costo sin Margen de Utilidad (%)</th>
                            <th>Costo con Margen de Utilidad (₡)</th>
                            <th>Empaques y/o Decoraciones Utilizados(as)</th>
                            <th>Costo por cantidad (₡)</th>
                            <th>Costo Empaques y/o Decoraciones (₡)</th>
                            <th>Implementos utilizados</th>
                            <th>Costo por cantidad (₡)</th>
                            <th>Costo Implementos (₡)</th>
                            <th>Suministros Utilizados</th>
                            <th>Costo por cantidad (₡)</th>
                            <th>Costo Suministros (₡)</th>
                            <th>Costo Total Insumos (₡)</th>
                            <th>Costo de Impresión Factura por Insumo (₡)</th>
                            <th>Costo Total de Impresión de Factura (₡)</th>
                            <th>Factura por Insumo (₡)</th>
                            <th>Factura Total (₡)</th>
                            <th>Total Insumos por Porcentaje de Ganancia (₡)</th>
                            <th>Porcentaje de IVA (%)</th>
                            <th>Porcentaje de Servicio (%)</th>
                            <th>Costo con IVA (₡)</th>
                            <th>Costo con Servicio (₡)</th>
                            <th>Plataforma de Envío</th>
                            <th>Envío (₡)</th>
                            <th>Precio Final (₡)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="tabla-global">
                        @foreach (var productofinal in Model.ProductosFinales)
                        {
                            <tr>
                                <td>@productofinal.id</td>

                                <td>
                                    @{
                                        var receta = Model.CostosRecetas?.FirstOrDefault(r => r.nombre == productofinal.nombre_receta);
                                    }
                                    @productofinal.nombre_receta
                                </td>

                                <td>
                                    ₡@productofinal.costo_total_receta.ToString("N2")
                                </td>

                                <td>@productofinal.margen_de_utilidad%</td>
                                <td>@(100 - productofinal.margen_de_utilidad)%</td>
                                <td>₡@productofinal.costo_con_margen_de_utilidad.ToString("N2")</td>

                                <!-- Empaques y/o Decoraciones -->
                                <td>
                                    @if (productofinal.EmpaquesDecoracionesUtilizados != null && productofinal.EmpaquesDecoracionesUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.EmpaquesDecoracionesUtilizados)
                                        {
                                            <div>@item.nombre (@item.cantidad @item.unidad_de_medida)</div>
                                        }
                                    }
                                    else
                                    {
                                        <div><em>Ninguno</em></div>
                                    }
                                </td>
                                <td>
                                    @if (productofinal.EmpaquesDecoracionesUtilizados != null && productofinal.EmpaquesDecoracionesUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.EmpaquesDecoracionesUtilizados)
                                        {
                                            <div>₡@((item.costo_por_cantidad * item.cantidad).ToString("N2"))</div>
                                        }
                                    }
                                </td>
                                <td>
                                    ₡@productofinal.costo_empaque_decoracion_utilizado.ToString("N2")
                                </td>

                                <!-- Implementos -->
                                <td>
                                    @if (productofinal.ImplementosUtilizados != null && productofinal.ImplementosUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.ImplementosUtilizados)
                                        {
                                            <div>@item.nombre (@item.cantidad @item.unidad_de_medida)</div>
                                        }
                                    }
                                    else
                                    {
                                        <div><em>Ninguno</em></div>
                                    }
                                </td>
                                <td>
                                    @if (productofinal.ImplementosUtilizados != null && productofinal.ImplementosUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.ImplementosUtilizados)
                                        {
                                            <div>₡@((item.costo_por_cantidad * item.cantidad).ToString("N2"))</div>
                                        }
                                    }
                                </td>
                                <td>
                                    ₡@productofinal.costo_implemento_utilizado.ToString("N2")
                                </td>

                                <!-- Suministros -->
                                <td>
                                    @if (productofinal.SuministrosUtilizados != null && productofinal.SuministrosUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.SuministrosUtilizados)
                                        {
                                            <div>
                                                @item.nombre (@item.cantidad @item.unidad_de_medida)
                                                @if (item.es_impresion_de_facturas)
                                                {
                                                    <span>(Sí es un suministro de impresión de facturas)</span>
                                                }
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div><em>Ninguno</em></div>
                                    }
                                </td>
                                <td>
                                    @if (productofinal.SuministrosUtilizados != null && productofinal.SuministrosUtilizados.Any())
                                    {
                                        foreach (var item in productofinal.SuministrosUtilizados)
                                        {
                                            <div>₡@((item.costo_por_cantidad * item.cantidad).ToString("N2"))</div>
                                        }
                                    }
                                </td>
                                <td>
                                    ₡@productofinal.costo_suministro_utilizado.ToString("N2")
                                </td>

                                <td>₡@productofinal.costo_total_insumos.ToString("N2")</td>

                                <td>₡@productofinal.costo_de_impresion_de_factura_por_insumo.ToString("N2")</td>
                                <td>₡@productofinal.costo_total_de_impresion_de_factura.ToString("N2")</td>
                                <td>₡@productofinal.factura_por_insumo.ToString("N2")</td>
                                <td>₡@productofinal.factura_total.ToString("N2")</td>
                                <td>₡@productofinal.costo_total_empaque_decoracion_implemento_suministro_por_porcentaje_de_ganancia.ToString("N2")</td>
                                <td>₡@productofinal.porcentaje_de_iva.ToString("N2")</td>
                                <td>₡@productofinal.porcentaje_de_servicio.ToString("N2")</td>
                                <td>₡@productofinal.costo_con_iva.ToString("N2")</td>
                                <td>₡@productofinal.costo_con_servicio.ToString("N2")</td>
                                <td>@productofinal.plataforma_de_envio</td>
                                <td>₡@productofinal.envio.ToString("N2")</td>
                                <td><strong>₡@productofinal.precio_final_sugerido.ToString("N2")</strong></td>

                                <td>
                                    <a href="@Url.Action("EditarProductoFinal", "Insumos", new { id = productofinal.id })" class="btn btn-custom-pink btn-sm fas fa-pencil" title="Editar"></a>
                                    <a href="@Url.Action("EliminarProductoFinal", "Insumos", new { id = productofinal.id })" class="btn btn-danger btn-sm btn-eliminar fas fa-trash" title="Eliminar" data-url="@Url.Action("EliminarProductoFinal", "Insumos", new { id = productofinal.id })"></a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js" defer></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js" defer></script>
    <script src="@Url.Content("~/Templates/js/paginaciones_y_exportaciones.js")" defer></script>
    <script src="@Url.Content("~/Templates/js/selects.js")" defer></script>
    <script src="@Url.Content("~/Templates/js/validaciones.js")"></script>
    <script src="@Url.Content("~/Templates/js/insumos.js")" defer></script>
    <!-- SweetAlert de éxito tras eliminación -->
    <script>
$(document).ready(function () {
    var msg = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(TempData["SuccessMessage"]));
    if (msg) {
        Swal.fire({
            icon: 'success',
            iconColor: '#82E0AA',
            text: msg,
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#B54885'
        });
    }
});
    </script>
    <script>
        $(document).ready(function () {
            $(document).on('submit', '#formPreciosFinalesSugeridos', function (e) {
                e.preventDefault();
                var $form = $(this);
                if (!$form.valid()) {
                    return false;
                }
                $.ajax({
                    url: $form.attr('action'),
                    type: $form.attr('method'),
                    data: $form.serialize(),
                    dataType: 'html',
                    success: function (response) {
                        var isJson = false;
                        var json;
                        if (typeof response === "object") {
                            json = response;
                            isJson = true;
                        } else if (typeof response === "string" && response.trim().startsWith("{") && response.trim().endsWith("}")) {
                            try {
                                json = JSON.parse(response);
                                isJson = true;
                            } catch (e) { }
                        }
                        // SweetAlert de éxito tras la Creación/Edición
                        if (isJson && json.success) {
                            Swal.fire({
                                icon: 'success',
                                iconColor: '#82E0AA',
                                text: json.message,
                                confirmButtonText: 'Aceptar',
                                confirmButtonColor: '#B54885'
                            }).then(function () {
                                location.reload();
                            });
                            return;
                        }
                        var $newForm = $(response).find('#formPreciosFinalesSugeridos');
                        if ($newForm.length) {
                            $('#formPreciosFinalesSugeridosContainer').html($newForm);
                            $newForm.validate({
                                errorElement: 'span',
                                errorClass: 'invalid-feedback',
                                highlight: function (element) { $(element).addClass('is-invalid'); },
                                unhighlight: function (element) { $(element).removeClass('is-invalid'); },
                                errorPlacement: function (error, element) { error.insertAfter(element); }
                            });
                        }
                    },
                    error: function () {
                        alert('Error al actualizar la receta.');
                    }
                });
            });
        });
    </script>
    <script>
        // JavaScript para personalizar los estilos y colores del checkbox de suministros utilizados
        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.custom-checkbox input[type="checkbox"]');
            checkboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                });
            });
        });
    </script>
}