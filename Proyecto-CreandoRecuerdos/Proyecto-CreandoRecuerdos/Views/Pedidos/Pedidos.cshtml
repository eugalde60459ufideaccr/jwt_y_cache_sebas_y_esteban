@model List<Proyecto_CreandoRecuerdos.Models.ProductoModel>
@{
    ViewData["Title"] = "Sistema de Pedidos";
}

@section Styles {
    <link href="@Url.Content("~/Templates/css/pedidos.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/botones.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Templates/css/validaciones.css")" rel="stylesheet" />
    <style>

        .pos-container {
            max-width: 98%;
            margin: 0 auto;
            padding: 0 15px;
        }

        .pos-products {
            padding-right: 0;
        }

        .pos-order-panel {
            padding-left: 15px;
        }

        #productGrid {
            display: flex;
            flex-wrap: wrap;
            margin-right: -5px;
        }

        .product-item {
            padding-right: 5px;
            padding-left: 5px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }


            .product-item .card {
                flex: 1;
                height: 100%;
                display: flex;
                flex-direction: column;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
            }

                .product-item .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }

            .product-item .card-img-container {
                position: relative;
                overflow: hidden;
                aspect-ratio: 1/1;
                background: #f5f5f5;
            }

            .product-item .card-img-top {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s;
            }

            .product-item .card:hover .card-img-top {
                transform: scale(1.05);
            }

            .product-item .card-body {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                padding: 12px;
            }

            .product-item .card-title {
                font-size: 1.1rem;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2C2C2C;
                min-height: auto;
            }


            .product-item .card-text {
                font-size: 0.9rem;
                flex-grow: 1;
                margin-bottom: 10px;
                color: #666;
                overflow: visible;
                white-space: normal;
                text-overflow: clip;
                display: block;
            }

            .product-item .card-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: transparent;
                border-top: none;
                margin-top: auto;
            }

            .product-item .text-muted {
                font-weight: bold;
                color: #CC8FAE !important;
            }
    </style>

}

<script>
    window.productosGlobales = @Html.Raw(ViewBag.ProductosJson);
</script>

<div class="container my-5">
    <h2 class="text-center" style="font-family: 'Sono', sans-serif;">
        <i class="fas fa-box-open" style="font-size: 24px; margin-right: 10px;"></i>
        Sistema de Pedidos
    </h2>
</div>

<div class="container-fluid pos-container">
    <div class="row">
        <!-- Categorías -->
        <div class="col-md-2 pos-categories">
            <div class="list-group" id="categoryList">
                <button class="list-group-item list-group-item-action active" data-category="0">
                    <i class="fas fa-th-list me-2"></i>Todos
                </button>
                @foreach (var categoria in ViewBag.Categorias)
                {
                    <button class="list-group-item list-group-item-action"
                            data-category="@categoria.id_categoria">
                        <i class="fas @ObtenerIconoCategoria(categoria.nombre) me-2"></i>@categoria.nombre
                    </button>
                }
                <button class="list-group-item list-group-item-action" data-category="recomendados">
                    <i class="fas fa-star me-2"></i>Recomendados
                </button>
            </div>
        </div>

        <!-- Productos -->
        <div class="col-md-6 pos-products">
            <div class="row" id="productGrid">
                @foreach (var producto in Model)
                {
                    <div class="col-md-4 mb-3 product-item"
                         data-id="@producto.id_producto"
                         data-category="@producto.id_categoria">
                        <div class="card h-100">
                            <img src="~/Templates/img/menu/@producto.img_url" class="card-img-top" alt="@producto.nombre">
                            <div class="card-body">
                                <h5 class="card-title">@producto.nombre</h5>
                                <p class="card-text">@producto.descripcion</p>
                                <p class="text-muted">₡@producto.precio_por_unidad.ToString("N0")</p>
                                <button class="btn btn-sm btn-primary add-to-cart"
                                        data-id="@producto.id_producto"
                                        data-name="@producto.nombre"
                                        data-price="@producto.precio_por_unidad">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Panel de pedido -->
        <div class="col-md-4 pos-order-panel">
            <div class="customer-info">
                <h5><i class="fas fa-user me-2"></i> Información del Cliente</h5>
                <div class="mb-2">
                    <label for="customerName" class="form-label">Nombre Completo *</label>
                    <input type="text" class="form-control" id="customerName"
                           placeholder="Nombre completo del cliente" required
                           maxlength="100">
                    <div class="invalid-feedback">Por favor ingrese su nombre completo</div>
                </div>
                <div class="mb-2">
                    <label for="customerPhone" class="form-label">Teléfono (opcional)</label>
                    <input type="text" class="form-control" id="customerPhone"
                           placeholder="88888888" maxlength="8"
                           pattern="\d{8}" title="8 dígitos sin guiones">
                    <small class="text-muted">Ej: 88888888</small>
                    <div class="invalid-feedback">El teléfono debe tener 8 dígitos</div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="takeawayOrder">
                    <label class="form-check-label" for="takeawayOrder">Para llevar</label>
                </div>
            </div>

            <div class="order-header">
                <h3><i class="fas fa-receipt me-2"></i> Pedido Actual</h3>
                <button class="btn btn-sm btn-outline-danger" id="clearOrderBtn">
                    <i class="fas fa-trash"></i> Limpiar
                </button>
            </div>

            <div class="order-items" id="orderItems">
                <div class="empty-order">
                    <i class="fas fa-shopping-cart"></i>
                    <p>No hay productos en el pedido</p>
                </div>
            </div>

            <div class="order-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="orderSubtotal">₡0</span>
                </div>
                <div class="summary-row">
                    <span>Impuestos (13%):</span>
                    <span id="orderTax">₡0</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="orderTotal">₡0</span>
                </div>
            </div>

            <div class="order-actions">
                <button class="btn btn-primary text-white" id="checkoutBtn">
                    <i class="fas fa-cash-register me-2"></i> Procesar Pago
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pedido Completado -->
<div class="modal fade" id="orderCompleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">¡Pedido Confirmado!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                    <h4>Tu pedido ha sido procesado con éxito</h4>
                </div>

                <div class="order-details">
                    <p><strong>Número de Pedido:</strong> <span class="order-number">ORD-2025-0015</span></p>
                    <p><strong>PIN:</strong> <span class="order-pin">1234</span></p>
                    <p><strong>Tiempo Estimado:</strong> <span class="order-time">20 minutos</span></p>
                </div>

                <div class="mt-4">
                    <p>Recibirás una notificación cuando tu pedido esté listo.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="printReceiptBtn">
                    <i class="fas fa-print me-2"></i> Imprimir Factura
                </button>
                <button type="button" class="btn btn-primary" id="newOrderBtn">
                    <i class="fas fa-plus me-2"></i> Nuevo Pedido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Valoración -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Valorar Pedido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p>¿Cómo calificarías tu experiencia con este pedido?</p>
                    <div class="rating-stars">
                        <i class="far fa-star fa-2x" data-rating="1"></i>
                        <i class="far fa-star fa-2x" data-rating="2"></i>
                        <i class="far fa-star fa-2x" data-rating="3"></i>
                        <i class="far fa-star fa-2x" data-rating="4"></i>
                        <i class="far fa-star fa-2x" data-rating="5"></i>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="ratingComments" class="form-label">Comentarios (opcional)</label>
                    <textarea class="form-control" id="ratingComments" rows="3" maxlength="500"
                              placeholder="¿Qué te gustó o qué podríamos mejorar?"></textarea>
                    <div class="text-end">
                        <small class="text-muted"><span id="charsLeft">500</span> caracteres restantes</small>
                    </div>
                </div>

                <div id="ratingError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="submitRatingBtn">Enviar Valoración</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="@Url.Content("~/Templates/js/validaciones.js")"></script>
    <script src="@Url.Content("~/Templates/js/pedidos.js")"></script>
    <script>
        // SCRIPTS HECHOS CON LA AYUDA DE IA
        // Función para obtener el ícono según la categoría
        function obtenerIconoCategoria(nombreCategoria) {
            const iconos = {
                'Desayunos': 'fa-coffee',
                'Paninis': 'fa-bread-slice',
                'Crepes': 'fa-blender',
                'Pastas': 'fa-pizza-slice',
                'Arroz': 'fa-utensils',
                'Tentaciones': 'fa-apple-alt',
                'Postres': 'fa-ice-cream',
                'Bebidas Calientes': 'fa-mug-hot',
                'Bebidas Frías': 'fa-glass-whiskey',
                'Especiales': 'fa-star'
            };

            return iconos[nombreCategoria] || 'fa-utensils';
        }
    </script>

    <script>
        // SCRIPTS HECHOS CON LA AYUDA DE IA
        document.addEventListener('DOMContentLoaded', () => {
            const sistemaPedidos = new SistemaPedidos();

            // Configurar evento para el botón de procesar pago
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                sistemaPedidos.procesarPago();
            });

            // Configurar eventos para los métodos de pago
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function () {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');

                    // Mostrar solo los detalles del método seleccionado
                    document.querySelectorAll('.payment-details').forEach(d => d.style.display = 'none');
                    document.getElementById(`${this.dataset.method}Details`).style.display = 'block';
                });
            });

            // Configurar evento para el botón de confirmar pago en el modal
            document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
                sistemaPedidos.confirmarPago();
            });
        });
    </script>
}

@functions {
    public string ObtenerIconoCategoria(string nombreCategoria)
    {
        var iconos = new Dictionary<string, string>
{
            { "Desayunos", "fa-coffee" },
            { "Panini", "fa-bread-slice" },
            { "Crepes", "fa-blender" },
            { "Pastas", "fa-pizza-slice" },
            { "Arroz", "fa-utensils" },
            { "Tentaciones", "fa-apple-alt" },
            { "Postres", "fa-ice-cream" },
            { "Bebidas Calientes", "fa-mug-hot" },
            { "Bebidas Frías", "fa-glass-whiskey" },
            { "Especiales", "fa-star" }
        };

        return iconos.TryGetValue(nombreCategoria, out var icono) ? icono : "fa-utensils";
    }
}